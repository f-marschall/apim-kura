name: Test Go Application

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      terraform_version:
        required: true
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  test-go-app:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ inputs.terraform_version }}
          terraform_wrapper: false

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Configure Terraform for Azure
        run: |
          echo "ARM_CLIENT_ID=${{ secrets.AZURE_CLIENT_ID }}" >> $GITHUB_ENV
          echo "ARM_TENANT_ID=${{ secrets.AZURE_TENANT_ID }}" >> $GITHUB_ENV
          echo "ARM_SUBSCRIPTION_ID=${{ secrets.AZURE_SUBSCRIPTION_ID }}" >> $GITHUB_ENV
          echo "ARM_USE_OIDC=true" >> $GITHUB_ENV

      - name: Build Go application
        run: go build -o kura .

      - name: Terraform Init
        working-directory: ./test/tf
        run: terraform init

      - name: Fetch subscription keys (before)
        run: |
          set -euo pipefail
          AZURE_SUB=$(az account show --query id -o tsv)
          API_VERSION="2022-08-01"
          BASE_URL="https://management.azure.com/subscriptions/${AZURE_SUB}/resourceGroups/${{ env.RESOURCE_GROUP }}/providers/Microsoft.ApiManagement/service/${{ env.APIM_NAME }}"

          SUBS=$(az rest --method get --url "${BASE_URL}/subscriptions?api-version=${API_VERSION}")

          RESULT="[]"
          for SID in $(echo "$SUBS" | jq -r '.value[] | select(.properties.displayName | startswith("Built-in") | not) | .name'); do
            SECRETS=$(az rest --method post --url "${BASE_URL}/subscriptions/${SID}/listSecrets?api-version=${API_VERSION}")
            DISPLAY_NAME=$(echo "$SUBS" | jq -r --arg sid "$SID" '.value[] | select(.name == $sid) | .properties.displayName')
            PRIMARY=$(echo "$SECRETS" | jq -r '.primaryKey')
            SECONDARY=$(echo "$SECRETS" | jq -r '.secondaryKey')

            RESULT=$(echo "$RESULT" | jq \
              --arg dn "$DISPLAY_NAME" \
              --arg pk "$PRIMARY" \
              --arg sk "$SECONDARY" \
              '. + [{"displayName": $dn, "primaryKey": $pk, "secondaryKey": $sk}]')
          done

          echo "$RESULT" | jq 'sort_by(.displayName)' > before.json
          echo "Saved $(echo "$RESULT" | jq length) subscription keys to before.json"

      - name: Run kura backup
        run: |
          ./kura backup \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --apim-name "${{ env.APIM_NAME }}" \
            --subscription "${{ secrets.AZURE_SUBSCRIPTION_ID }}" \
            --output backup.json

      - name: Delete all subscription resources
        working-directory: ./test/tf
        run: |
          terraform destroy \
            -target='azurerm_api_management_subscription.global_subscription' \
            -target='azurerm_api_management_subscription.product_subscription' \
            -target='azurerm_api_management_subscription.api_subscription' \
            -var="environment=${{ inputs.environment }}" \
            -auto-approve

      - name: Run kura restore
        run: |
          ./kura restore \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --apim-name "${{ env.APIM_NAME }}" \
            --subscription "${{ secrets.AZURE_SUBSCRIPTION_ID }}" \
            --input backup.json

      - name: Fetch subscription keys (after)
        run: |
          set -euo pipefail
          AZURE_SUB=$(az account show --query id -o tsv)
          API_VERSION="2022-08-01"
          BASE_URL="https://management.azure.com/subscriptions/${AZURE_SUB}/resourceGroups/${{ env.RESOURCE_GROUP }}/providers/Microsoft.ApiManagement/service/${{ env.APIM_NAME }}"

          SUBS=$(az rest --method get --url "${BASE_URL}/subscriptions?api-version=${API_VERSION}")

          RESULT="[]"
          for SID in $(echo "$SUBS" | jq -r '.value[] | select(.properties.displayName | startswith("Built-in") | not) | .name'); do
            SECRETS=$(az rest --method post --url "${BASE_URL}/subscriptions/${SID}/listSecrets?api-version=${API_VERSION}")
            DISPLAY_NAME=$(echo "$SUBS" | jq -r --arg sid "$SID" '.value[] | select(.name == $sid) | .properties.displayName')
            PRIMARY=$(echo "$SECRETS" | jq -r '.primaryKey')
            SECONDARY=$(echo "$SECRETS" | jq -r '.secondaryKey')

            RESULT=$(echo "$RESULT" | jq \
              --arg dn "$DISPLAY_NAME" \
              --arg pk "$PRIMARY" \
              --arg sk "$SECONDARY" \
              '. + [{"displayName": $dn, "primaryKey": $pk, "secondaryKey": $sk}]')
          done

          echo "$RESULT" | jq 'sort_by(.displayName)' > after.json
          echo "Saved $(echo "$RESULT" | jq length) subscription keys to after.json"

      - name: Compare subscription keys
        run: |
          echo "=== Before (subscription count): $(jq length before.json) ==="
          echo "=== After  (subscription count): $(jq length after.json) ==="

          if diff <(jq -S . before.json) <(jq -S . after.json); then
            echo "✓ All subscription keys match! Backup and restore successful."
          else
            echo ""
            echo "✗ Subscription keys do not match after restore!"
            echo ""
            echo "--- Before ---"
            jq . before.json
            echo "--- After ---"
            jq . after.json
            exit 1
          fi
