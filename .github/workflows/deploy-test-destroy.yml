name: Deploy, Test, and Destroy APIM

on:
  push:
    branches:
      - main
    paths:
      - 'test/tf/**'
      - '.github/workflows/deploy-test-destroy.yml'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  id-token: write
  contents: read

env:
  TERRAFORM_VERSION: 1.14.4

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    defaults:
      run:
        working-directory: ./test/tf
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Configure Terraform for Azure
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true
        run: |
          echo "ARM_CLIENT_ID=$ARM_CLIENT_ID" >> $GITHUB_ENV
          echo "ARM_TENANT_ID=$ARM_TENANT_ID" >> $GITHUB_ENV
          echo "ARM_SUBSCRIPTION_ID=$ARM_SUBSCRIPTION_ID" >> $GITHUB_ENV
          echo "ARM_USE_OIDC=true" >> $GITHUB_ENV

      - name: Terraform Init
        run: terraform init

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Plan
        run: terraform plan -var="environment=${{ github.ref_name }}" -out=tfplan

      - name: Terraform Apply
        run: terraform apply -var="environment=${{ github.ref_name }}" -auto-approve tfplan
        
      - name: Get API Management outputs
        run: |
          terraform output -json > outputs.json
          echo "Terraform outputs saved successfully"

      - name: Test API endpoint
        run: |
          GATEWAY_URL=$(terraform output -raw gateway_url | xargs)
          echo "Testing API endpoint at: ${GATEWAY_URL}/sample/get"
          for i in {1..5}; do
            echo "Attempt $i..."
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -H "Ocp-Apim-Subscription-Key: placeholder" "${GATEWAY_URL}/sample/get")
            echo "HTTP Status: $HTTP_CODE"
            if [ "$HTTP_CODE" = "401" ] || [ "$HTTP_CODE" = "403" ]; then
              echo "✓ API is responding (auth required is expected)"
              break
            elif [ "$HTTP_CODE" = "200" ]; then
              echo "✓ API is responding"
              break
            else
              echo "✗ API not responding yet, waiting 30 seconds..."
              sleep 30
            fi
          done

  test-go-app:
    name: Test Go Application
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Configure Terraform for Azure
        run: |
          echo "ARM_CLIENT_ID=${{ secrets.AZURE_CLIENT_ID }}" >> $GITHUB_ENV
          echo "ARM_TENANT_ID=${{ secrets.AZURE_TENANT_ID }}" >> $GITHUB_ENV
          echo "ARM_SUBSCRIPTION_ID=${{ secrets.AZURE_SUBSCRIPTION_ID }}" >> $GITHUB_ENV
          echo "ARM_USE_OIDC=true" >> $GITHUB_ENV

      - name: Build Go application
        run: go build -o kura .

      - name: Terraform Init
        working-directory: ./test/tf
        run: terraform init

      - name: Fetch subscription keys (before)
        run: |
          set -euo pipefail
          AZURE_SUB=$(az account show --query id -o tsv)
          API_VERSION="2022-08-01"
          BASE_URL="https://management.azure.com/subscriptions/${AZURE_SUB}/resourceGroups/${{ env.RESOURCE_GROUP }}/providers/Microsoft.ApiManagement/service/${{ env.APIM_NAME }}"

          SUBS=$(az rest --method get --url "${BASE_URL}/subscriptions?api-version=${API_VERSION}")

          RESULT="[]"
          for SID in $(echo "$SUBS" | jq -r '.value[] | select(.properties.displayName | startswith("Built-in") | not) | .name'); do
            SECRETS=$(az rest --method post --url "${BASE_URL}/subscriptions/${SID}/listSecrets?api-version=${API_VERSION}")
            DISPLAY_NAME=$(echo "$SUBS" | jq -r --arg sid "$SID" '.value[] | select(.name == $sid) | .properties.displayName')
            PRIMARY=$(echo "$SECRETS" | jq -r '.primaryKey')
            SECONDARY=$(echo "$SECRETS" | jq -r '.secondaryKey')

            RESULT=$(echo "$RESULT" | jq \
              --arg dn "$DISPLAY_NAME" \
              --arg pk "$PRIMARY" \
              --arg sk "$SECONDARY" \
              '. + [{"displayName": $dn, "primaryKey": $pk, "secondaryKey": $sk}]')
          done

          echo "$RESULT" | jq 'sort_by(.displayName)' > before.json
          echo "Saved $(echo "$RESULT" | jq length) subscription keys to before.json"

      - name: Run kura backup
        run: |
          ./kura backup \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --apim-name "${{ env.APIM_NAME }}" \
            --subscription "${{ secrets.AZURE_SUBSCRIPTION_ID }}" \
            --output backup.json

      - name: Delete all subscription resources
        working-directory: ./test/tf
        run: |
          terraform destroy \
            -target='azurerm_api_management_subscription.global_subscription' \
            -target='azurerm_api_management_subscription.product_subscription' \
            -target='azurerm_api_management_subscription.api_subscription' \
            -var="environment=${{ github.ref_name }}" \
            -auto-approve

      - name: Run kura restore
        run: |
          ./kura restore \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --apim-name "${{ env.APIM_NAME }}" \
            --subscription "${{ secrets.AZURE_SUBSCRIPTION_ID }}" \
            --input backup.json

      - name: Fetch subscription keys (after)
        run: |
          set -euo pipefail
          AZURE_SUB=$(az account show --query id -o tsv)
          API_VERSION="2022-08-01"
          BASE_URL="https://management.azure.com/subscriptions/${AZURE_SUB}/resourceGroups/${{ env.RESOURCE_GROUP }}/providers/Microsoft.ApiManagement/service/${{ env.APIM_NAME }}"

          SUBS=$(az rest --method get --url "${BASE_URL}/subscriptions?api-version=${API_VERSION}")

          RESULT="[]"
          for SID in $(echo "$SUBS" | jq -r '.value[] | select(.properties.displayName | startswith("Built-in") | not) | .name'); do
            SECRETS=$(az rest --method post --url "${BASE_URL}/subscriptions/${SID}/listSecrets?api-version=${API_VERSION}")
            DISPLAY_NAME=$(echo "$SUBS" | jq -r --arg sid "$SID" '.value[] | select(.name == $sid) | .properties.displayName')
            PRIMARY=$(echo "$SECRETS" | jq -r '.primaryKey')
            SECONDARY=$(echo "$SECRETS" | jq -r '.secondaryKey')

            RESULT=$(echo "$RESULT" | jq \
              --arg dn "$DISPLAY_NAME" \
              --arg pk "$PRIMARY" \
              --arg sk "$SECONDARY" \
              '. + [{"displayName": $dn, "primaryKey": $pk, "secondaryKey": $sk}]')
          done

          echo "$RESULT" | jq 'sort_by(.displayName)' > after.json
          echo "Saved $(echo "$RESULT" | jq length) subscription keys to after.json"

      - name: Compare subscription keys
        run: |
          echo "=== Before (subscription count): $(jq length before.json) ==="
          echo "=== After  (subscription count): $(jq length after.json) ==="

          if diff <(jq -S . before.json) <(jq -S . after.json); then
            echo "✓ All subscription keys match! Backup and restore successful."
          else
            echo ""
            echo "✗ Subscription keys do not match after restore!"
            echo ""
            echo "--- Before ---"
            jq . before.json
            echo "--- After ---"
            jq . after.json
            exit 1
          fi

  release:
    name: Release
    runs-on: ubuntu-latest
    needs: test-go-app
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Determine version
        id: version
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          # Increment patch version
          MAJOR=$(echo "$LATEST_TAG" | sed 's/v//' | cut -d. -f1)
          MINOR=$(echo "$LATEST_TAG" | sed 's/v//' | cut -d. -f2)
          PATCH=$(echo "$LATEST_TAG" | sed 's/v//' | cut -d. -f3)
          NEW_VERSION="v${MAJOR}.${MINOR}.$((PATCH + 1))"
          echo "version=${NEW_VERSION}" >> "$GITHUB_OUTPUT"
          echo "Releasing version: ${NEW_VERSION}"

      - name: Build binaries
        run: |
          VERSION=${{ steps.version.outputs.version }}
          MODULE="github.com/f-marschall/apim-kura/cmd"
          LDFLAGS="-X '${MODULE}.Version=${VERSION}'"

          GOOS=linux   GOARCH=amd64 go build -ldflags="${LDFLAGS}" -o kura-linux-amd64 .
          GOOS=linux   GOARCH=arm64 go build -ldflags="${LDFLAGS}" -o kura-linux-arm64 .
          GOOS=darwin  GOARCH=amd64 go build -ldflags="${LDFLAGS}" -o kura-darwin-amd64 .
          GOOS=darwin  GOARCH=arm64 go build -ldflags="${LDFLAGS}" -o kura-darwin-arm64 .
          GOOS=windows GOARCH=amd64 go build -ldflags="${LDFLAGS}" -o kura-windows-amd64.exe .

      - name: Create Git tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag ${{ steps.version.outputs.version }}
          git push origin ${{ steps.version.outputs.version }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          generate_release_notes: true
          files: |
            kura-linux-amd64
            kura-linux-arm64
            kura-darwin-amd64
            kura-darwin-arm64
            kura-windows-amd64.exe
